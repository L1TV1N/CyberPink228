<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planner — История поездок</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    body { background:#f9f9f9; font-family:'Inter',sans-serif; margin:0; padding:0; }
    .container { max-width:1000px; margin:auto; padding:1em; }
    header { background:#4CAF50; color:#fff; padding:1em; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:1.5em; margin:0; }
    header button { background:#fff; color:#4CAF50; padding:0.5em 1em; border-radius:8px; border:none; cursor:pointer; transition:0.3s; }
    header button:hover { background:#e6e6e6; }

    .filters { display:flex; flex-wrap:wrap; margin:1em 0; gap:0.5em; }
    .filters select, .filters input { padding:0.5em; border-radius:8px; border:1px solid #ddd; }

    #historyList { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1em; }
    .history-card { background:#fff; padding:1em; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; flex-direction:column; transition:0.3s; cursor:pointer; }
    .history-card:hover { transform:scale(1.02); box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    .history-card h3 { margin-bottom:0.3em; font-size:1.1em; }
    .history-card p { font-size:0.9em; color:#555; margin-bottom:0.3em; }
    .history-card small { color:#999; }

    #mapModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999; }
    #mapModal .modal-content { width:90%; max-width:800px; height:80%; background:#fff; border-radius:12px; position:relative; padding:1em; display:flex; flex-direction:column; }
    #mapModal #modalMap { flex:1; border-radius:8px; }
    #mapModal .close-btn { position:absolute; top:10px; right:10px; background:#4CAF50; color:#fff; border:none; border-radius:8px; padding:0.5em 1em; cursor:pointer; }

    @media (max-width:768px){
      header { flex-direction:column; align-items:flex-start; gap:0.5em; }
      .filters { flex-direction:column; }
      #historyList { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>История поездок</h1>
    <button id="btn-back">Назад</button>
  </header>

  <main class="container">
    <div class="filters">
      <input type="text" id="searchInput" placeholder="Поиск по названию...">
      <select id="filterDate">
        <option value="">Все даты</option>
        <option value="last7">Последние 7 дней</option>
        <option value="last30">Последние 30 дней</option>
      </select>
      <select id="filterVehicle">
        <option value="">Все транспортные средства</option>
        <option value="car">Машина</option>
        <option value="bicycle">Велосипед</option>
        <option value="foot">Пешком</option>
      </select>
    </div>

    <div id="historyList"></div>
  </main>

  <div id="mapModal">
    <div class="modal-content">
      <button class="close-btn" id="closeMapBtn">Закрыть</button>
      <div id="modalMap"></div>
    </div>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="js/api.js"></script>
  <script src="js/map.js"></script>
  <script src="js/history.js"></script>
  <script>
    // Логика фильтров и поиска
    const searchInput = document.getElementById('searchInput');
    const filterDate = document.getElementById('filterDate');
    const filterVehicle = document.getElementById('filterVehicle');
    const historyList = document.getElementById('historyList');

    async function loadHistory() {
      const trips = await api.get('/routes/history');
      window.historyTrips = trips; // для фильтров
      renderTrips(trips);
    }

    function renderTrips(trips) {
      historyList.innerHTML = '';
      if (!trips || trips.length === 0) {
        historyList.innerHTML = '<p>История пустая</p>';
        return;
      }
      trips.forEach(trip => {
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML = `
          <h3>${trip.name}</h3>
          <p>Транспорт: ${trip.vehicle || '-'}</p>
          <p>Точек: ${trip.points.length}</p>
          <small>${new Date(trip.date).toLocaleString()}</small>
        `;
        card.addEventListener('click', () => showTripOnMap(trip));
        historyList.appendChild(card);
      });
    }

    function applyFilters() {
      let filtered = [...window.historyTrips];
      const search = searchInput.value.toLowerCase();
      if (search) filtered = filtered.filter(t => t.name.toLowerCase().includes(search));
      if (filterVehicle.value) filtered = filtered.filter(t => t.vehicle === filterVehicle.value);
      if (filterDate.value) {
        const now = Date.now();
        const days = filterDate.value === 'last7' ? 7 : 30;
        filtered = filtered.filter(t => (now - new Date(t.date).getTime())/1000/3600/24 <= days);
      }
      renderTrips(filtered);
    }

    searchInput.addEventListener('input', applyFilters);
    filterDate.addEventListener('change', applyFilters);
    filterVehicle.addEventListener('change', applyFilters);

    // --- Модальное окно с картой ---
    const mapModal = document.getElementById('mapModal');
    const closeMapBtn = document.getElementById('closeMapBtn');
    let modalMap;

    function showTripOnMap(trip) {
      mapModal.style.display = 'flex';
      if (modalMap) {
        modalMap.remove();
        document.getElementById('modalMap').innerHTML = '';
      }
      modalMap = L.map('modalMap').setView([55.751244, 37.618423], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(modalMap);

      const markers = L.markerClusterGroup();
      trip.points.forEach(p => {
        const marker = L.marker([parseFloat(p.lat), parseFloat(p.lng)]).bindPopup(`${p.name || ''}`);
        markers.addLayer(marker);
      });
      modalMap.addLayer(markers);
      modalMap.fitBounds(markers.getBounds());
    }

    closeMapBtn.addEventListener('click', () => { mapModal.style.display = 'none'; });

    document.getElementById('btn-back').addEventListener('click', () => { window.location.href = 'index.html'; });

    loadHistory();
  </script>
</body>
</html>
